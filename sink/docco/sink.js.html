<!DOCTYPE html>

<html>
<head>
  <title>sink.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>sink.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>A path based set where the most specific path wins.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> Supersede = <span class="hljs-built_in">require</span>(<span class="hljs-string">'supersede'</span>)

</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Log entry sequence number. TODO Needs to wrap, or else use Monotonic.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> sequence = <span class="hljs-number">0</span>

</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>No filters here. If you want filter you can decorate your sink. Replace the
reosolved sink with one that wraps the reosolved sink. Do what you need to do
with the log entry before passing it on to the original sink.</p>

            </div>

        </li>


        <li id="section-4">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>We do allow you to short circuit logging with levels which are associated
with a path. Filterering can also be done by the Prolific monitor process,
but this saves the trouble of serializing the deserializing only to throw
away the results.</p>

            </div>

        </li>


        <li id="section-5">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>I’ve wanted to optimize away this level check, but it has been of some use to
me, so I’m going to try to find a way to make it easier to adjust so I’ll
find more use for it.</p>

            </div>

        </li>


        <li id="section-6">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Map of paths to levels.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> levels = <span class="hljs-keyword">new</span> Supersede
</pre></div></div>

        </li>


        <li id="section-7">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Default level is <code>info</code> for all paths.</p>

            </div>

            <div class="content"><div class='highlight'><pre>levels.set([ <span class="hljs-string">''</span> ], <span class="hljs-string">'info'</span>)

</pre></div></div>

        </li>


        <li id="section-8">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Map of level names to numbers.</p>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> LEVEL = { <span class="hljs-attr">none</span>: <span class="hljs-number">-1</span>, <span class="hljs-attr">error</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">warn</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">info</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">debug</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">trace</span>: <span class="hljs-number">4</span> }

</pre></div></div>

        </li>


        <li id="section-9">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Replace with a dummy date for testing.</p>

            </div>

            <div class="content"><div class='highlight'><pre>exports.Date = <span class="hljs-built_in">Date</span>

</pre></div></div>

        </li>


        <li id="section-10">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Accept a log entry and turn it into a JSON object.</p>

            </div>

        </li>


        <li id="section-11">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre>exports.json = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path, level, qualifier, name, properties</span>) </span>{
    <span class="hljs-keyword">if</span> (LEVEL[level] &gt; LEVEL[levels.get(path)]) {
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">var</span> entry = {
        <span class="hljs-attr">when</span>: exports.Date.now(),
        <span class="hljs-attr">sequence</span>: sequence++,
        <span class="hljs-attr">pid</span>: process.pid,
        <span class="hljs-attr">level</span>: level,
        <span class="hljs-attr">qualifier</span>: qualifier,
        <span class="hljs-attr">name</span>: name,
        <span class="hljs-attr">qualified</span>: qualifier + <span class="hljs-string">'#'</span> + name
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> exports.properties) {
        <span class="hljs-keyword">if</span> (!(key <span class="hljs-keyword">in</span> entry)) {
            entry[key] = exports.properties[key]
        }
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> properties) {
        <span class="hljs-keyword">if</span> (!(key <span class="hljs-keyword">in</span> entry)) {
            entry[key] = properties[key]
        }
    }
</pre></div></div>

        </li>


        <li id="section-12">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>TODO Do not write out JSON. We want to allow decoration for extension.
The reason you’re serializing here is because you’d imagined that you
could advise people to just put <code>stdout</code> as the <code>writer</code>, but that will
never happen, and a simple decorator could do that anyway.</p>

            </div>

            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.queue.push(entry)
}

exports.queue = { <span class="hljs-attr">push</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{} }

exports.setLevel = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path, level</span>) </span>{
    <span class="hljs-keyword">if</span> (level == <span class="hljs-literal">null</span>) {
        level = path
        path = <span class="hljs-string">''</span>
    } <span class="hljs-keyword">else</span> {
        path = <span class="hljs-string">'.'</span> + path
    }
    levels.set(path.split(<span class="hljs-string">'.'</span>), level)
}

exports.clearLevel = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">context</span>) </span>{
    <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) {
        levels.remove([ <span class="hljs-string">''</span> ])
        levels.set([ <span class="hljs-string">''</span> ], <span class="hljs-string">'info'</span>)
    } <span class="hljs-keyword">else</span> {
        levels.remove((<span class="hljs-string">'.'</span> + context).split(<span class="hljs-string">'.'</span>))
    }
}

exports.getLevel = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path</span>) </span>{
    <span class="hljs-keyword">return</span> levels.get((<span class="hljs-string">'.'</span> + path).split(<span class="hljs-string">'.'</span>))
}

exports.properties = {}

exports.filename = <span class="hljs-built_in">module</span>.filename

</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
